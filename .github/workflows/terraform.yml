name: Terraform CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'

env:
  TF_VERSION: "1.5.7"
  WORKING_DIR: terraform

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Write Snowflake private key
        run: |
          mkdir -p ../snowflake_key
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY }}" > ../snowflake_key/rsa_key.p8
        working-directory: ${{ env.WORKING_DIR }}

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<EOF
          environment                      = "${{ vars.ENVIRONMENT }}"
          project_name                     = "${{ vars.PROJECT_NAME }}"
          snowflake_organization_name      = "${{ secrets.SNOWFLAKE_ORG_NAME }}"
          snowflake_account_name           = "${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}"
          snowflake_user                   = "${{ secrets.SNOWFLAKE_USER }}"
          snowflake_role                   = "ACCOUNTADMIN"
          snowflake_warehouse              = "COMPUTE_WH"
          snowflake_private_key_path       = "../snowflake_key/rsa_key.p8"
          snowflake_private_key_passphrase = "${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}"
          database_name                    = "${{ vars.DATABASE_NAME }}"
          raw_schema_name                  = "RAW"
          s3_bucket_name                   = "${{ vars.S3_BUCKET_NAME }}"
          s3_bucket_path                   = "${{ vars.S3_BUCKET_PATH }}"
          s3_bucket_url                    = "${{ vars.S3_BUCKET_URL }}"
          aws_role_arn                     = "${{ secrets.AWS_ROLE_ARN }}"
          EOF
        working-directory: ${{ env.WORKING_DIR }}

      - name: Format tfvars
        run: terraform fmt terraform.tfvars
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Format Check
        run: terraform fmt -check
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.WORKING_DIR }}
